# Copyright 2024 Canonical Ltd.
# See LICENSE file for licensing details.

name: synapse
summary: Synapse rock
description: Synapse OCI image for the Synapse charm
version: "1.0"
base: ubuntu@22.04
# renovate: base: ubuntu:22.04@sha256:e6173d4dc55e76b87c4af8db8821b1feae4146dd47341e4d431118c7dd060a74
build-base: ubuntu@22.04
# renovate: build-base: ubuntu:22.04@sha256:e6173d4dc55e76b87c4af8db8821b1feae4146dd47341e4d431118c7dd060a74
license: Apache-2.0
platforms:
  amd64:
parts:
    synapse:
        build-packages:
            - build-essential
            - curl
            - git
            - libffi-dev
            - libicu-dev
            - libjpeg-dev
            - libpq-dev
            - libssl-dev
            - libwebp-dev
            - libxml++2.6-dev
            - libxslt1-dev
            - openssl
            - pkg-config
            - zlib1g-dev
        stage-packages:
            - bash
            - coreutils
            - curl
            - gosu
            - libffi-dev
            - libicu70
            - libjemalloc2
            - libjpeg-turbo8
            - libpq5
            - libssl-dev
            - libwebp7
            - openssl
            - xmlsec1
            - python3
        stage-snaps:
            - mjolnir/latest/edge
            - matrix-appservice-irc/latest/edge
            - synapse-stats-exporter/latest/edge
        plugin: nil
        source: https://github.com/matrix-org/synapse/
        source-type: git
        source-tag: v1.96.1
        override-build: |
            craftctl default
            export RUSTUP_HOME=/rust
            export CARGO_HOME=/cargo
            export PATH=/cargo/bin:/rust/bin:$PATH
            export CARGO_NET_GIT_FETCH_WITH_CLI=false
            mkdir -p /rust /cargo /synapse /install
            curl -m 30 -sSf https://sh.rustup.rs | sh -s -- -y --no-modify-path --default-toolchain stable --profile minimal
            /rust/toolchains/stable-x86_64-unknown-linux-gnu/bin/rustc -V > $CRAFT_PART_INSTALL/rust-version
            export PYTHONPATH=/usr/lib/python310.zip:/usr/lib/python3.10:/usr/lib/python3.10/lib-dynload:/root/parts/synapse/install/lib/python3.10/site-packages
            pip3 install --root-user-action=ignore "poetry==1.3.2"
            cp pyproject.toml poetry.lock /synapse/
            /root/parts/synapse/install/usr/local/bin/poetry export --extras all -o /synapse/requirements.txt
            pip3 install --prefix="/install" --no-deps --no-warn-script-location -r /synapse/requirements.txt
            cp -r synapse /synapse/
            cp -r rust /synapse/
            cp pyproject.toml README.rst build_rust.py Cargo.toml Cargo.lock /synapse/
            pip3 install --prefix="/install" --no-deps --no-warn-script-location /synapse[all];
            cp docker/start.py $CRAFT_PART_INSTALL/
            chmod 755 $CRAFT_PART_INSTALL/start.py
            sed -i 's/#!\/usr\/local\/bin\/python/#!\/usr\/bin\/python3/' $CRAFT_PART_INSTALL/start.py
            cp -r docker/conf $CRAFT_PART_INSTALL/
            cp -r /usr/local $CRAFT_PART_INSTALL/usr/
            cp -r /install/local/* $CRAFT_PART_INSTALL/usr/local/
            mkdir -p $CRAFT_PART_INSTALL/usr/local/attributemaps
            chmod 755 $CRAFT_PART_INSTALL/usr/local/attributemaps
            rm -f $CRAFT_PART_INSTALL/bin/pip $CRAFT_PART_INSTALL/bin/pip3 $CRAFT_PART_INSTALL/bin/python3 $CRAFT_PART_INSTALL/bin/pip3.10 $CRAFT_PART_INSTALL/bin/python3.10
        overlay-packages:
            - ca-certificates
    synapse-conf:
        plugin: dump
        source: attributemaps
        organize:
            login_ubuntu.py: /usr/local/attributemaps/login_ubuntu.py
